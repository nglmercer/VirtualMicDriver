name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DRIVER_NAME: virtual_mic
  BUILD_CONFIGURATION: Debug

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Install Windows Driver Kit (WDK)
      run: |
        Write-Host "Installing Windows Driver Kit..."
        # Windows-latest runners come with WDK pre-installed
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
          Write-Host "✅ WDK found at: $wdkPath"
          # List available versions
          Get-ChildItem -Path "$wdkPath\Include" | ForEach-Object {
            Write-Host "  Available version: $($_.Name)"
          }
        } else {
          Write-Host "❌ WDK not found"
          exit 1
        }
    
    - name: Enable Test Signing Mode
      run: |
        Write-Host "Enabling test signing mode for driver development..."
        bcdedit /set testsigning on
        Write-Host "Test signing enabled (requires reboot to take effect)"
    
    - name: Create build directory
      run: cmake -E make_directory ${{github.workspace}}/build
    
    - name: Configure CMake
      working-directory: ${{github.workspace}}/build
      run: cmake .. -G "Visual Studio 17 2022" -A x64
    
    - name: Build driver
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config ${{env.BUILD_CONFIGURATION}}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: driver-binaries
        path: |
          ${{github.workspace}}/build/**/*.sys
          ${{github.workspace}}/build/**/*.pdb
        retention-days: 30
    
    - name: Verify driver binary
      run: |
        Write-Host "Verifying driver binary..."
        $driverPath = Get-ChildItem -Path "${{github.workspace}}/build" -Filter "*.sys" -Recurse | Select-Object -First 1
        if ($driverPath) {
          Write-Host "✅ Driver built successfully: $($driverPath.FullName)"
          Write-Host "   Size: $($driverPath.Length) bytes"
        } else {
          Write-Host "❌ Driver binary not found!"
          exit 1
        }

  static-analysis:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Windows Driver Kit (WDK)
      run: |
        Write-Host "Windows Driver Kit is available on windows-latest runner"
    
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: Run PREfast analysis
      run: |
        Write-Host "Running PREfast static analysis..."
        cd build
        msbuild virtual_mic.vcxproj /p:Configuration=Debug /p:RunCodeAnalysis=true

  security-scan:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Windows Driver Kit (WDK)
      run: |
        Write-Host "Windows Driver Kit is available on windows-latest runner"
    
    - name: Install BinSkim
      run: |
        dotnet tool install --global Microsoft.CodeAnalysis.BinSkim
    
    - name: Run BinSkim security scan
      run: |
        Write-Host "Running BinSkim security analysis..."
        $binSkimPath = "$env:USERPROFILE\.dotnet\tools\binskim.exe"
        if (Test-Path $binSkimPath) {
          & $binSkimPath analyze build/**/*.sys --recurse --output-File BinSkimResults.sarif --verbose
        } else {
          Write-Host "BinSkim not found, skipping..."
        }
    
    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: BinSkimResults.sarif
        retention-days: 30

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate documentation
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        doxygen Doxyfile 2>/dev/null || echo "Doxygen config not found, skipping"
    
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/html/
        retention-days: 30

  test:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Windows Driver Kit (WDK)
      run: |
        Write-Host "Windows Driver Kit is available on windows-latest runner"
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: driver-binaries
        path: build/
    
    - name: Run CTest
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_CONFIGURATION}} --output-on-failure --verbose
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/Testing/
        retention-days: 30

  release:
    runs-on: windows-latest
    needs: [build, static-analysis, security-scan, test]
    if: github.ref == 'refs/heads/main' && always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: driver-binaries
        path: release/
    
    - name: Create release package
      run: |
        New-Item -ItemType Directory -Path "release/package" -Force
        Copy-Item "virtual_mic.inf" -Destination "release/package/" -ErrorAction SilentlyContinue
        Copy-Item "build/**/*.sys" -Destination "release/package/" -Recurse
        Copy-Item "README.md" -Destination "release/package/"
        Copy-Item "install.bat" -Destination "release/package/" -ErrorAction SilentlyContinue
        Copy-Item "uninstall.bat" -Destination "release/package/" -ErrorAction SilentlyContinue
        
        # Create ZIP package
        Compress-Archive -Path "release/package/*" -DestinationPath "release/virtual_mic_driver.zip"
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: release/virtual_mic_driver.zip
        retention-days: 90
    
    - name: Generate checksums
      run: |
        cd release
        Get-FileHash virtual_mic_driver.zip -Algorithm SHA256 | Select-Object -ExpandProperty Hash > virtual_mic_driver.zip.sha256
        Get-Content virtual_mic_driver.zip.sha256
    
    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: release-checksums
        path: release/virtual_mic_driver.zip.sha256
        retention-days: 90

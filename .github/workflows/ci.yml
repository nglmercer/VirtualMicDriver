name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DRIVER_NAME: virtual_mic
  BUILD_CONFIGURATION: Debug

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Install Windows Driver Kit (WDK)
      shell: pwsh
      run: |
        Write-Host "Installing Windows Driver Kit (WDK) with kernel components..."
        
        # Download WDK ISO
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2268326"
        $wdkIso = "$env:TEMP\wdk.iso"
        $mountPoint = "$env:TEMP\wdk_mount"
        
        Write-Host "Downloading WDK from $wdkUrl..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $wdkIso -UseBasicParsing
        
        # Create mount point
        New-Item -ItemType Directory -Path $mountPoint -Force | Out-Null
        
        Write-Host "Mounting WDK ISO..."
        Mount-DiskImage -ImagePath $wdkIso -StorageType ISO | Out-Null
        $driveLetter = (Get-DiskImage -ImagePath $wdkIso | Get-Volume).DriveLetter
        $drivePath = "${driveLetter}:\"
        
        Write-Host "Installing WDK from $drivePath..."
        # Run the WDK installer with silent mode
        Start-Process -FilePath "$drivePath\Installers\WDKSetup.exe" -ArgumentList "/quiet", "/norestart" -Wait
        
        # Wait for installation to complete
        Start-Sleep -Seconds 60
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $wdkIso | Out-Null
        Remove-Item $wdkIso -Force
        Remove-Item $mountPoint -Force -Recurse
        
        Write-Host "WDK installation completed"
        
        # Verify kernel components installation
        Write-Host "Verifying kernel components..."
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
            Write-Host "✅ WDK found at: $wdkPath"
            Get-ChildItem -Path "$wdkPath\Include" -Directory | ForEach-Object {
                $kmPath = "$($_.FullName)\km"
                if (Test-Path $kmPath) {
                    Write-Host "✅ Found kernel-mode (km) directory in: $($_.Name)"
                }
            }
        } else {
            Write-Host "❌ WDK not found"
            exit 1
        }
    
    - name: Verify WDK installation
      run: |
        Write-Host "Verifying WDK installation..."
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
          Write-Host "✅ WDK found at: $wdkPath"
          # List available versions
          Get-ChildItem -Path "$wdkPath\Include" | ForEach-Object {
            Write-Host "  Available version: $($_.Name)"
            # Check if km directory exists (kernel-mode)
            $kmPath = "$wdkPath\Include\$($_.Name)\km"
            if (Test-Path $kmPath) {
              Write-Host "    ✅ Kernel-mode (km) directory found"
            } else {
              Write-Host "    ❌ Kernel-mode (km) directory NOT found"
            }
          }
        } else {
          Write-Host "❌ WDK not found"
          exit 1
        }
    
    - name: Enable Test Signing Mode
      run: |
        Write-Host "Enabling test signing mode for driver development..."
        try {
          bcdedit /set testsigning on
          Write-Host "Test signing enabled (requires reboot to take effect)"
        } catch {
          Write-Host "Warning: Could not enable test signing mode. This may be expected in CI environment."
        }
    
    - name: Create build directory
      run: cmake -E make_directory ${{github.workspace}}/build
    
    - name: Configure CMake
      working-directory: ${{github.workspace}}/build
      run: cmake .. -G "Visual Studio 17 2022" -A x64
    
    - name: Build driver
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --config ${{env.BUILD_CONFIGURATION}}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: driver-binaries
        path: |
          ${{github.workspace}}/build/**/*.sys
          ${{github.workspace}}/build/**/*.pdb
        retention-days: 30
    
    - name: Verify driver binary
      run: |
        Write-Host "Verifying driver binary..."
        $driverPath = Get-ChildItem -Path "${{github.workspace}}/build" -Filter "*.sys" -Recurse | Select-Object -First 1
        if ($driverPath) {
          Write-Host "✅ Driver built successfully: $($driverPath.FullName)"
          Write-Host "   Size: $($driverPath.Length) bytes"
        } else {
          Write-Host "❌ Driver binary not found!"
          exit 1
        }

  static-analysis:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Windows Driver Kit (WDK)
      shell: pwsh
      run: |
        Write-Host "Installing Windows Driver Kit (WDK) with kernel components..."
        
        # Download WDK ISO
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2268326"
        $wdkIso = "$env:TEMP\wdk.iso"
        $mountPoint = "$env:TEMP\wdk_mount"
        
        Write-Host "Downloading WDK from $wdkUrl..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $wdkIso -UseBasicParsing
        
        # Create mount point
        New-Item -ItemType Directory -Path $mountPoint -Force | Out-Null
        
        Write-Host "Mounting WDK ISO..."
        Mount-DiskImage -ImagePath $wdkIso -StorageType ISO | Out-Null
        $driveLetter = (Get-DiskImage -ImagePath $wdkIso | Get-Volume).DriveLetter
        $drivePath = "${driveLetter}:\"
        
        Write-Host "Installing WDK from $drivePath..."
        # Run the WDK installer with silent mode
        Start-Process -FilePath "$drivePath\Installers\WDKSetup.exe" -ArgumentList "/quiet", "/norestart" -Wait
        
        # Wait for installation to complete
        Start-Sleep -Seconds 60
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $wdkIso | Out-Null
        Remove-Item $wdkIso -Force
        Remove-Item $mountPoint -Force -Recurse
        
        Write-Host "WDK installation completed"
        
        # Verify kernel components installation
        Write-Host "Verifying kernel components..."
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
            Write-Host "✅ WDK found at: $wdkPath"
            Get-ChildItem -Path "$wdkPath\Include" -Directory | ForEach-Object {
                $kmPath = "$($_.FullName)\km"
                if (Test-Path $kmPath) {
                    Write-Host "✅ Found kernel-mode (km) directory in: $($_.Name)"
                }
            }
        } else {
            Write-Host "❌ WDK not found"
            exit 1
        }
    
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: Run PREfast analysis
      run: |
        Write-Host "Running PREfast static analysis..."
        cd build
        $projectFiles = Get-ChildItem -Path "." -Filter "*.vcxproj" -Recurse
        if ($projectFiles) {
          foreach ($project in $projectFiles) {
            Write-Host "Running PREfast on $($project.Name)..."
            msbuild $project.FullName /p:Configuration=Debug /p:RunCodeAnalysis=true
          }
        } else {
          Write-Host "No .vcxproj files found, skipping PREfast analysis"
        }

  security-scan:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Windows Driver Kit (WDK)
      shell: pwsh
      run: |
        Write-Host "Installing Windows Driver Kit (WDK) with kernel components..."
        
        # Download WDK ISO
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2268326"
        $wdkIso = "$env:TEMP\wdk.iso"
        $mountPoint = "$env:TEMP\wdk_mount"
        
        Write-Host "Downloading WDK from $wdkUrl..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $wdkIso -UseBasicParsing
        
        # Create mount point
        New-Item -ItemType Directory -Path $mountPoint -Force | Out-Null
        
        Write-Host "Mounting WDK ISO..."
        Mount-DiskImage -ImagePath $wdkIso -StorageType ISO | Out-Null
        $driveLetter = (Get-DiskImage -ImagePath $wdkIso | Get-Volume).DriveLetter
        $drivePath = "${driveLetter}:\"
        
        Write-Host "Installing WDK from $drivePath..."
        # Run the WDK installer with silent mode
        Start-Process -FilePath "$drivePath\Installers\WDKSetup.exe" -ArgumentList "/quiet", "/norestart" -Wait
        
        # Wait for installation to complete
        Start-Sleep -Seconds 60
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $wdkIso | Out-Null
        Remove-Item $wdkIso -Force
        Remove-Item $mountPoint -Force -Recurse
        
        Write-Host "WDK installation completed"
        
        # Verify kernel components installation
        Write-Host "Verifying kernel components..."
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
            Write-Host "✅ WDK found at: $wdkPath"
            Get-ChildItem -Path "$wdkPath\Include" -Directory | ForEach-Object {
                $kmPath = "$($_.FullName)\km"
                if (Test-Path $kmPath) {
                    Write-Host "✅ Found kernel-mode (km) directory in: $($_.Name)"
                }
            }
        } else {
            Write-Host "❌ WDK not found"
            exit 1
        }
    
    - name: Install BinSkim
      run: |
        dotnet tool install --global Microsoft.CodeAnalysis.BinSkim
    
    - name: Run BinSkim security scan
      run: |
        Write-Host "Running BinSkim security analysis..."
        $binSkimPath = "$env:USERPROFILE\.dotnet\tools\binskim.exe"
        if (Test-Path $binSkimPath) {
          & $binSkimPath analyze build/**/*.sys --recurse --output-File BinSkimResults.sarif --verbose
        } else {
          Write-Host "BinSkim not found, skipping..."
        }
    
    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: BinSkimResults.sarif
        retention-days: 30

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate documentation
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        doxygen Doxyfile 2>/dev/null || echo "Doxygen config not found, skipping"
    
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/html/
        retention-days: 30

  test:
    runs-on: windows-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Install Windows Driver Kit (WDK)
      shell: pwsh
      run: |
        Write-Host "Installing Windows Driver Kit (WDK) with kernel components..."
        
        # Download WDK ISO
        $wdkUrl = "https://go.microsoft.com/fwlink/?linkid=2268326"
        $wdkIso = "$env:TEMP\wdk.iso"
        $mountPoint = "$env:TEMP\wdk_mount"
        
        Write-Host "Downloading WDK from $wdkUrl..."
        Invoke-WebRequest -Uri $wdkUrl -OutFile $wdkIso -UseBasicParsing
        
        # Create mount point
        New-Item -ItemType Directory -Path $mountPoint -Force | Out-Null
        
        Write-Host "Mounting WDK ISO..."
        Mount-DiskImage -ImagePath $wdkIso -StorageType ISO | Out-Null
        $driveLetter = (Get-DiskImage -ImagePath $wdkIso | Get-Volume).DriveLetter
        $drivePath = "${driveLetter}:\"
        
        Write-Host "Installing WDK from $drivePath..."
        # Run the WDK installer with silent mode
        Start-Process -FilePath "$drivePath\Installers\WDKSetup.exe" -ArgumentList "/quiet", "/norestart" -Wait
        
        # Wait for installation to complete
        Start-Sleep -Seconds 60
        
        # Dismount ISO
        Dismount-DiskImage -ImagePath $wdkIso | Out-Null
        Remove-Item $wdkIso -Force
        Remove-Item $mountPoint -Force -Recurse
        
        Write-Host "WDK installation completed"
        
        # Verify kernel components installation
        Write-Host "Verifying kernel components..."
        $wdkPath = "${env:ProgramFiles(x86)}\Windows Kits\10"
        if (Test-Path $wdkPath) {
            Write-Host "✅ WDK found at: $wdkPath"
            Get-ChildItem -Path "$wdkPath\Include" -Directory | ForEach-Object {
                $kmPath = "$($_.FullName)\km"
                if (Test-Path $kmPath) {
                    Write-Host "✅ Found kernel-mode (km) directory in: $($_.Name)"
                }
            }
        } else {
            Write-Host "❌ WDK not found"
            exit 1
        }
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: driver-binaries
        path: build/
    
    - name: Run CTest
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_CONFIGURATION}} --output-on-failure --verbose
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: build/Testing/
        retention-days: 30

  release:
    runs-on: windows-latest
    needs: [build, static-analysis, security-scan, test]
    if: github.ref == 'refs/heads/main' && always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: driver-binaries
        path: release/
    
    - name: Create release package
      run: |
        New-Item -ItemType Directory -Path "release/package" -Force
        Copy-Item "virtual_mic.inf" -Destination "release/package/" -ErrorAction SilentlyContinue
        Copy-Item "build/**/*.sys" -Destination "release/package/" -Recurse
        Copy-Item "README.md" -Destination "release/package/"
        Copy-Item "install.bat" -Destination "release/package/" -ErrorAction SilentlyContinue
        Copy-Item "uninstall.bat" -Destination "release/package/" -ErrorAction SilentlyContinue
        
        # Create ZIP package
        Compress-Archive -Path "release/package/*" -DestinationPath "release/virtual_mic_driver.zip"
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: release/virtual_mic_driver.zip
        retention-days: 90
    
    - name: Generate checksums
      run: |
        cd release
        Get-FileHash virtual_mic_driver.zip -Algorithm SHA256 | Select-Object -ExpandProperty Hash > virtual_mic_driver.zip.sha256
        Get-Content virtual_mic_driver.zip.sha256
    
    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: release-checksums
        path: release/virtual_mic_driver.zip.sha256
        retention-days: 90
